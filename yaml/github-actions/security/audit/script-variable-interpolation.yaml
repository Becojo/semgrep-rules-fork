rules:
  - id: script-variable-interpolation
    languages: [yaml]
    severity: WARNING
    message: >-
      Detected variable interpolation in `actions/github-script` step.
      Place the variable in an environment variable to avoid the risk of code injection.
    metadata:
      cwe: "CWE-77: Improper Neutralization of Special Elements used in a Command ('Command Injection')"
      category: security
      technology:
        - github-actions
      confidence: LOW
      likelihood: LOW
      impact: MEDIUM
      subcategory:
        - audit
      references:
        - "https://securitylab.github.com/research/github-actions-untrusted-input/"
    paths:
      include:
        - .github/
        - action.yml
        - action.yaml
        - script-variable-interpolation.test.yaml
    patterns:
      - pattern-inside: |
          steps: [..., $STEP, ...]

      - pattern-inside: |
          $STEP

      - pattern-inside: |
          ...
          uses: "=~/actions/github-script@.*/"
          ...

      - pattern-inside: |
          with: ...

      - pattern-inside: |
          script: ...

      - pattern-regex: >-
          (\$\{\{[^\}]+\}\})

      - focus-metavariable: $1
